@{
    ViewBag.Title = "新增外送地址";
    Layout = "~/Areas/P/Views/Shared/_LayoutWxPage.cshtml";
}
<style type="text/css">
    /************************* Just Reset Browser Default CSS : BEGIN ***************************/
    html {
        background-color: #fff;
    }

    body, div, h1, h2, h3, h4, ul, li, form, input, dl, dt, dd, p {
        margin: 0;
        padding: 0;
        font-family: "微软雅黑";
    }

    h3 {
        + font-size : 14 px;
        _font-size: 14px;
    }

    img {
        border: none;
    }

    .c {
        clear: both;
    }

    ul, ol, li {
        list-style: none;
    }

    /*清除浮动*/
    .clearfix:after {
        content: ".";
        visibility: hidden;
        display: block;
        height: 0;
        overflow: hidden;
        clear: both;
    }

    /* no ie mac \*/
    * html .clearfix {
        height: 1%;
    }

    /* end */
    * + html .clearfix {
        height: 1%;
    }

    body {
        font: 12px / 1.5em 微软雅黑, Arial, Verdana, Helvetica, sans-serif;
        color: #333;
    }

    button, input, select, textarea {
        color: #999;
    }

        input[type="button"] {
            padding: 0 5px;
            color: #333;
        }

    .demo_box {
        float: left;
        width: 100%;
        height: 500px;
    }

    /* map style */
    #iCenter {
        float: left;
        width: 98%;
        height: 366px;
        margin-top: 10px;
        margin-left: 2px;
        /*margin-right: 10px;*/
        border: 1px solid #F6F6F6;
    }

    #r_title {
        width: 98%;
        line-height: 28px;
        padding-left: 5px;
        background-color: #D1EEEE;
        font-weight: bold;
    }

    #result {
        width: 98%;
        overflow: auto;
        margin-bottom: 5px;
        /*    width:661px;
    height: 255px;*/
    }

        /*  结果项 */
        #result .sub_result {
            font-size: 12px;
            cursor: pointer;
            line-height: 20px;
            /*padding:0px 0 4px 2px;*/
            border-bottom: 1px solid #C1FFC1;
        }

            #result .sub_result .detail {
            }

                #result .sub_result .detail h3 {
                    color: #00A6AC;
                }

    a {
        color: #067EC0;
        text-decoration: none;
    }

        a:hover {
            text-decoration: underline;
        }

    .note {
        color: #999;
    }

    /*** layerout stylesheet ***/
    /* 修改背景URL */
    div.change {
        background-image: url(http://pages.haozu.ajkcdn.com/20110909/img/map/marker-h.png);
    }

        div.change div {
            background-image: url(http://pages.haozu.ajkcdn.com/20110909/img/map/marker-h-l.gif);
        }

    /*** copied from demo #39 添加自定义点覆盖物 ***/
    /* 定义自定义点样式 */
    .markerContentStyle {
        position: relative;
    }

        .markerContentStyle span {
            background-color: #FFFFFF;
            color: #FF1493;
            width: 120px;
            heigth: 80px;
            border: 2px solid #D8BFD8;
            FONT-FAMILY: 华文行楷;
            position: absolute;
            top: -10px;
            left: 25px;
            white-space: nowrap -webkit-border-radius : 5 px;
            border-radius: 5px;
        }

    /*** copied from demo #43 添加自定义信息窗体 ***/
    /* 定义自定义信息窗体样式 */
    div.info {
        position: relative;
        z-index: 100;
        border: 1px solid #BCBCBC;
        box-shadow: 0 0 10px #B7B6B6;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.9);
        transition-duration: 0.25s;
    }

        div.info:hover {
            box-shadow: 0px 0px 15px #0CF;
        }

    div.info-top {
        position: relative;
        background: none repeat scroll 0 0 #F9F9F9;
        border-bottom: 1px solid #CCC;
        border-radius: 5px 5px 0 0;
    }

        div.info-top div {
            display: inline-block;
            color: #333333;
            font-size: 14px;
            font-weight: bold;
            line-height: 31px;
            padding: 0 10px;
        }

        div.info-top img {
            position: absolute;
            top: 10px;
            right: 10px;
            transition-duration: 0.25s;
        }

            div.info-top img:hover {
                box-shadow: 0px 0px 5px #000;
            }

    div.info-middle {
        font-size: 12px;
        padding: 10px;
        line-height: 21px;
    }

    div.info-bottom {
        height: 0px;
        width: 100%;
        clear: both;
        text-align: center;
    }

        div.info-bottom img {
            position: relative;
            z-index: 104;
        }

    input.inputTextStyle {
        width: 72%;
        height: 24px;
        font-size: 16px;
        /*margin: 5px;*/
        padding: 2px;
        display: inline;
    }

    input.btn {
        color: #000000;
        height: 30px;
        font-size: 16px;
        margin: 5px;
        padding: 2px;
        display: inline;
    }

    b.b_text {
        font-size: 16px;
        margin: 5px 0px 5px 10px;
        _padding-bottom: 2px;
        _margin-left: 20px;
        _margin-bottom: 10px;
        *padding-bottom: 2px;
        *margin-bottom: 10px;
        display: inline;
        *width: 1;
        width: auto;
        overflow: auto;
        *overflow: visible;
        zoom: 1;
    }

    label.l_text {
        font-weight: bold;
        font-size: 14px;
        margin: 5px 0px 5px 10px;
        _padding-bottom: 2px;
        _margin-left: 20px;
        _margin-bottom: 10px;
        *padding-bottom: 2px;
        *margin-bottom: 10px;
        display: inline;
        *width: 1;
        width: auto;
        overflow: auto;
        *overflow: visible;
        zoom: 1;
    }

    .weui-dialog {
        z-index: 10000 !important;
    }
    /*** -------------------------***/
</style>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=af56fee14fd4e4098d4edb2e25a3782c&plugin=AMap.Geocoder"></script>
@section scripts{
<script type="text/javascript">
    $(document).ready(function () {
        getGskHospitalDetail();
        showMap();
        if ('@ViewBag.GroupType' == '3') {
            $("#btnSubmitApplication").attr("disabled", "true");
            $('#btnSubmitApplication').css("background-color", "rgba(0, 0, 0, 0.3)");
        }
    })

    var mapObj;  //地图对象
    var lnglatXY;  //当前对象坐标
    var aimAddress;  //当前对象地址
    var geocoderMarker = undefined;  //逆编码跟随鼠标移动视图
    var searchMarker = [];  //搜索结果信息标记
    var windowsArr = [];  //搜索结果地图信息
    var addressArr = [];  //搜索结果地址集合
    var mainProvince;
    var mainCity;
    var addProvince;
    var addCity;
    var addDistrict;
    var mainLat;
    var mainLng;
    var hospitalData;
    var _market;
    var _ta;
    var _gskHospitalCode;
    var _hospitalName;
    var _otherAddressDistance = '';
    var _actionType;
    var _addressApplicationID;
    var _addAddressUpdate;
    var resultString = "";
    var count = 0;
    var selectAddress = '';
    var selectaddressArr = [];
    var mainAddress;
    var walking;
    var _addressName = "";

    function GetUrlParam(paraName) {
        var url = document.location.toString();
        var arrObj = url.split("?");

        if (arrObj.length > 1) {
            var arrPara = arrObj[1].split("&");
            var arr;

            for (var i = 0; i < arrPara.length; i++) {
                arr = arrPara[i].split("=");

                if (arr != null && arr[0] == paraName) {
                    return arr[1];
                }
            }
            return "";
        }
        else {
            return "";
        }
    }

    function getGskHospitalDetail() {
        var _gskHospital = GetUrlParam('hospitalcode');
        _actionType = GetUrlParam('actionType');
        if (_actionType == "UPDATE" || _actionType == "RESUBMIT") {
            post('/P/PreApproval/LoadAddressApprovalInfoForUpdate', {
                id: GetUrlParam('addressApplicationID')
            },
                function (d) {
                    mainAddress = d.data.MainHospitalAddress;
                    _addAddressUpdate = d.data.AddAddress;
                    $('#keyword').val(_addAddressUpdate);
                    _hospitalName = d.data.HospitalName;
                    mainProvince = d.data.Province;
                    document.getElementById('province').innerHTML = "省份：" + d.data.Province;
                    mainCity = d.data.City;
                    document.getElementById('city').innerHTML = "城市：" + d.data.City;
                    document.getElementById('address').innerHTML = "" + d.data.MainHospitalAddress;
                    mainLat = d.data.MainLat;
                    mainLng = d.data.MainLng;
                    if (mainCity == "市辖区") {
                        $.ajax({
                            type: "get",
                            url: "https://restapi.amap.com/v3/geocode/geo?key=be67a85eb1ef6e18344653c31760d319&address=" + mainAddress + "&city=" + mainProvince,
                            cache: false,
                            async: false,
                            success: function (data) {
                                if (data.status == 1 && data.count > 0) {
                                    mainLng = data.geocodes[0].location.split(',')[0];
                                    mainLat = data.geocodes[0].location.split(',')[1];
                                }
                            }
                        });
                    }
                    else {
                        $.ajax({
                            type: "get",
                            url: "https://restapi.amap.com/v3/geocode/geo?key=be67a85eb1ef6e18344653c31760d319&address=" + mainAddress + "&city=" + mainCity,
                            cache: false,
                            async: false,
                            success: function (data) {
                                if (data.status == 1 && data.count > 0) {
                                    mainLng = data.geocodes[0].location.split(',')[0];
                                    mainLat = data.geocodes[0].location.split(',')[1];
                                }
                            }
                        });
                    }
                    //if (mainLat == '0' || mainLng == '0') {
                    //    
                    //}
                }, 'json');

        } else {
            post('/P/PreApproval/SearchHospitalByGskHospital', {
                gskHospital: _gskHospital
            },
                function (d) {
                    hospitalData = d.rows;
                    for (var i = 0; i < d.rows.length; i++) {
                        if (d.rows[i].MainAddress == "主地址") {
                            mainAddress = d.rows[i].Address;
                            _hospitalName = d.rows[i].Name;
                            mainProvince = d.rows[i].ProvinceName;
                            document.getElementById('province').innerHTML = "省份：" + d.rows[i].ProvinceName;
                            mainCity = d.rows[i].CityName;
                            document.getElementById('city').innerHTML = "城市：" + d.rows[i].CityName;
                            document.getElementById('address').innerHTML = "" + d.rows[i].Address;
                            mainLat = d.rows[i].Latitude;
                            mainLng = d.rows[i].Longitude;
                            if (mainCity == "市辖区") {
                                $.ajax({
                                    type: "get",
                                    url: "https://restapi.amap.com/v3/geocode/geo?key=be67a85eb1ef6e18344653c31760d319&address=" + mainAddress + "&city=" + mainProvince,
                                    cache: false,
                                    async: false,
                                    success: function (data) {
                                        if (data.status == 1 && data.count > 0) {
                                            mainLng = data.geocodes[0].location.split(',')[0];
                                            mainLat = data.geocodes[0].location.split(',')[1];
                                        }
                                    }
                                });
                            } else {
                                $.ajax({
                                    type: "get",
                                    url: "https://restapi.amap.com/v3/geocode/geo?key=be67a85eb1ef6e18344653c31760d319&address=" + mainAddress + "&city=" + mainCity,
                                    cache: false,
                                    async: false,
                                    success: function (data) {
                                        if (data.status == 1 && data.count > 0) {
                                            mainLng = data.geocodes[0].location.split(',')[0];
                                            mainLat = data.geocodes[0].location.split(',')[1];
                                        }
                                    }
                                });
                            }
                            //if (mainLat == '0' || mainLng == '0') {
                            //    $.ajax({
                            //        type: "get",
                            //        url: "https://restapi.amap.com/v3/geocode/geo?key=be67a85eb1ef6e18344653c31760d319&address=" + mainAddress + "&city=" + mainCity,
                            //        cache: false,
                            //        async: false,
                            //        success: function (data) {
                            //            if (data.status == 1 && data.count > 0) {
                            //                mainLng = data.geocodes[0].location.split(',')[0];
                            //                mainLat = data.geocodes[0].location.split(',')[1];
                            //            }
                            //        }
                            //    });
                            //}
                            break;
                        }
                    }
                }, 'json');
        }
    }

    function showMap() {  //显示地图
        var self = this;
        var mapEle = document.getElementById("mapBg");
        mapEle.style.display = "block";
        self.mapInit();
    }

    function makeSure() {  //点击确认
        var self = this;
        var aim = document.getElementById("keyword");
        aim.value = aimAddress || "";
    }

    function mapInit() {  //创建地图并绑定监听事件
        var self = this;

        mapObj = new AMap.Map("iCenter", {
            view: new AMap.View2D({
                //center:new AMap.LngLat(116.397428,39.90923),//地图中心点
                zoom: 12 //地图显示的缩放级别
            })
        });

        mapObj = new AMap.Map('iCenter');
        mapObj.plugin('AMap.Geolocation', function () {
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,//是否使用高精度定位，默认:true
                timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                maximumAge: 0,           //定位结果缓存0毫秒，默认：0
                convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                showButton: true,        //显示定位按钮，默认：true
                buttonPosition: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
                buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                showMarker: true,        //定位成功后在定位到的位置显示点标记，默认：true
                showCircle: true,        //定位成功后用圆圈表示定位精度范围，默认：true
                panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
                zoomToAccuracy: true      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
            });
            mapObj.addControl(geolocation);
            geolocation.getCurrentPosition();
            //geolocation.getCurrentPosition(function (status, result) {
            //    if (status == 'complete') {
            //        onComplete(result);
            //    } else {
            //        onError(result);
            //    }
            //});
            AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
            AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
        });

        var listener = AMap.event.addListener(mapObj, "click", function (e) {
            _addressName = "";
            mapObj.clearMap();  // 清楚所有覆盖物
            lnglatXY = e.lnglat;
            var listenMarker = new AMap.Marker({
                map: mapObj,
                position: e.lnglat,
                icon: "http://webapi.amap.com/images/0.png",
                offset: new AMap.Pixel(-10, -34)
            });
            mapObj.setCenter(lnglatXY);
            self.geocoder();
        });

        AMap.plugin(["AMap.Walking"], function () {
            var drivingOption = {
                map: mapObj
            };
            walking = new AMap.Walking(drivingOption); //构造导航类

            //walking.search(new AMap.LngLat(121.612, 38.9102), new AMap.LngLat(121.513478, 38.84731));


            AMap.event.addListener(walking, 'complete', walkingComplete);//返回定位信息
            AMap.event.addListener(walking, 'error', walkingError);
        });
    }
    function onComplete(data) {
        if (count > 0) {
            lnglatXY = data.position;
            addProvince = data.addressComponent.province;
            addCity = data.addressComponent.city;
            addDistrict = data.addressComponent.district
            address = data.formattedAddress.replace(addProvince, '').replace(addCity, '').replace(addDistrict, '');
            aimAddress = address;
            makeSure();
        }
        count += 1;
    }
    function onError(data) {
        alert('获取地理位置信息失败');
    }
    function geocoder() {  //通过坐标找到具体地址
        var MGeocoder;
        //加载地理编码插件
        mapObj.plugin(["AMap.Geocoder"], function () {
            MGeocoder = new AMap.Geocoder({
                radius: 1000,
                extensions: "all"
            });
            //返回地理编码结果
            AMap.event.addListener(MGeocoder, "complete", geocoder_CallBack);
            //逆地理编码
            MGeocoder.getAddress(lnglatXY);
        });

        //加点
        var marker = new AMap.Marker({
            map: mapObj,
            icon: new AMap.Icon({
                image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_bs.png",
                size: new AMap.Size(58, 30),
                imageOffset: new AMap.Pixel(0, -0)
            }),
            position: lnglatXY,
            offset: new AMap.Pixel(-5, -30)
        });
        mapObj.setFitView();
    }

    //鼠标划过显示相应点

    function onMouseOver(e) {
        var coor = e.split(',');
        var lnglat = new AMap.LngLat(coor[0], coor[1]);

        if (!geocoderMarker) {
            geocoderMarker = new AMap.Marker({
                map: mapObj,
                icon: "http://webapi.amap.com/images/0.png",
                position: lnglat,
                offset: new AMap.Pixel(-10, -34)
            });
        } else {
            geocoderMarker.setPosition(lnglat);
        }
        mapObj.setFitView();
    }

    //回调函数
    function geocoder_CallBack(data) {
        geocoderMarker = undefined;
        var resultStr = "";
        var roadinfo = "";
        var poiinfo = "";
        var address;
        //返回地址描述
        addProvince = data.regeocode.addressComponent.province;
        addCity = data.regeocode.addressComponent.city;
        addDistrict = data.regeocode.addressComponent.district
        //address = data.regeocode.formattedAddress.replace(addProvince, '').replace(addCity, '').replace(addDistrict, '');
        if (selectAddress != '')
            address = selectAddress;
        else
            address = data.regeocode.addressComponent.street + data.regeocode.addressComponent.streetNumber;
        aimAddress = address;
        selectAddress = '';
        makeSure();  //把当前地址赋值给文本框
        //返回周边道路信息
        roadinfo += "<table style='width:600px'>";
        for (var i = 0; i < data.regeocode.roads.length; i++) {
            var color = (i % 2 === 0 ? '#fff' : '#eee');
            roadinfo += "<tr style='background-color:" + color + "; margin:0; padding:0;'><td>道路：" + data.regeocode.roads[i].name + "</td><td>方向：" + data.regeocode.roads[i].direction + "</td><td>距离：" + data.regeocode.roads[i].distance + "米</td></tr>";
        }
        roadinfo += "</table>";
        //返回周边兴趣点信息
        //poiinfo += "<table style='width:600px;cursor:pointer;'>";
        //for (var j = 0; j < data.regeocode.pois.length; j++) {
        //    var color = j % 2 === 0 ? '#fff' : '#eee';
        //    poiinfo += "<tr onmouseover='onMouseOver(\"" + data.regeocode.pois[j].location.toString() + "\")' style='background-color:" + color + "; margin:0; padding:0;'><td>兴趣点：" + data.regeocode.pois[j].name + "</td><td>类型：" + data.regeocode.pois[j].type + "</td><td>距离：" + data.regeocode.pois[j].distance + "米</td></tr>";
        //}
        //poiinfo += "</table>";
        //返回结果拼接输出
        //resultStr = "<div style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + address + "<hr/><b>周边道路信息</b>：<br/>" + roadinfo + "<hr/><b>周边兴趣点信息</b>：<br/>" + poiinfo + "</div>";
        //resultStr = "<div style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + address + "<hr/><b>周边道路信息</b>：<br/>" + roadinfo + "</div>";
        document.getElementById("result").innerHTML = resultStr;
        resultString = '';
    }

    //输入提示
    function autoSearch() {
        var keywords = document.getElementById("keyword").value;
        var auto;
        //加载输入提示插件
        mapObj.plugin(["AMap.Autocomplete"], function () {
            var autoOptions = {
                city: "" //城市，默认全国
            };
            auto = new AMap.Autocomplete(autoOptions);
            //查询成功时返回查询结果
            if (keywords.length > 0) {
                AMap.event.addListener(auto, "complete", autocomplete_CallBack);
                auto.search(keywords);
            }
            else {
                document.getElementById("result1").style.display = "none";
            }
        });
    }

    //输出输入提示结果的回调函数
    function autocomplete_CallBack(data) {
        var resultStr = "";
        var tipArr = data.tips;
        if (tipArr && tipArr.length > 0) {
            for (var i = 0; i < tipArr.length; i++) {
                resultStr += "<div id='divid" + (i + 1) + "' onmouseover='openMarkerTipById(" + (i + 1)
                    + ",this)' onclick='selectResult(" + i + ")' onmouseout='onmouseout_MarkerStyle(" + (i + 1)
                    + ",this)' style=\"font-size: 13px;cursor:pointer;padding:5px 5px 5px 5px;\"" + "data=" + tipArr[i].adcode + ">" + tipArr[i].name + "<span style='color:#C1C1C1;'>" + tipArr[i].district + "</span></div>";
            }
            resultString = '';
            document.getElementById("result1").style.display = "block";
        }
        else {
            resultString = "无效地址";
            document.getElementById("result1").style.display = "none";
            //resultStr = " π__π 亲,人家找不到结果!<br />要不试试：<br />1.请确保所有字词拼写正确<br />2.尝试不同的关键字<br />3.尝试更宽泛的关键字";
        }
        addProvince = 'undefined';
        addCity = 'undefined';
        document.getElementById("result1").curSelect = -1;
        document.getElementById("result1").tipArr = tipArr;
        document.getElementById("result1").innerHTML = resultStr;
    }

    //输入提示框鼠标滑过时的样式
    function openMarkerTipById(pointid, thiss) {  //根据id打开搜索结果点tip
        thiss.style.background = '#CAE1FF';
    }

    //输入提示框鼠标移出时的样式
    function onmouseout_MarkerStyle(pointid, thiss) {  //鼠标移开后点样式恢复
        thiss.style.background = "";
    }

    //从输入提示框中选择关键字并查询
    function selectResult(index) {
        if (index < 0) {
            return;
        }
        if (navigator.userAgent.indexOf("MSIE") > 0) {
            document.getElementById("keyword").onpropertychange = null;
            document.getElementById("keyword").onfocus = focus_callback;
        }
        //截取输入提示的关键字部分
        var text = document.getElementById("divid" + (index + 1)).innerHTML.replace(/<[^>].*?>.*<\/[^>].*?>/g, "");
        var cityCode = document.getElementById("divid" + (index + 1)).getAttribute('data');
        document.getElementById("keyword").value = text;
        document.getElementById("result1").style.display = "none";
        //根据选择的输入提示关键字查询
        mapObj.plugin(["AMap.PlaceSearch"], function () {
            var msearch = new AMap.PlaceSearch();  //构造地点查询类
            AMap.event.addListener(msearch, "complete", placeSearch_CallBack); //查询成功时的回调函数
            msearch.setCity(cityCode);
            msearch.search(text);  //关键字查询查询
        });
    }

    //定位选择输入提示关键字
    function focus_callback() {
        if (navigator.userAgent.indexOf("MSIE") > 0) {
            document.getElementById("keyword").onpropertychange = autoSearch;
        }
    }

    //输出关键字查询结果的回调函数
    function placeSearch_CallBack(data) {
        //清空地图上的InfoWindow和Marker
        windowsArr = [];
        searchMarker = [];
        addressArr = [];
        selectaddressArr = [];
        mapObj.clearMap();
        var resultStr1 = "";
        var poiArr = data.poiList.pois;
        var resultCount = poiArr.length;
        for (var i = 0; i < resultCount; i++) {
            addressArr[i] = poiArr[i].location;
            selectaddressArr[i] = [poiArr[i].address, poiArr[i].name];
            resultStr1 += "<div id='divid" + (i + 1) + "' onmouseover='openMarkerTipById1(" + i + ",this)' onclick='autoClickMap(" + i + ",this)' onmouseout='onmouseout_MarkerStyle(" + (i + 1) + ",this)' style=\"font-size: 12px;cursor:pointer;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\"><table><tr><td><img src=\"http://webapi.amap.com/images/" + (i + 1) + ".png\"></td>" + "<td><h3><font color=\"#00a6ac\">名称: " + poiArr[i].name + "</font></h3>";
            resultStr1 += TipContents(poiArr[i].type, poiArr[i].address, poiArr[i].tel) + "</td></tr></table></div>";
            addmarker(i, poiArr[i]);
            resultString = '';
        }
        mapObj.setFitView();
        addProvince = 'undefined';
        addCity = 'undefined';
        document.getElementById("result").innerHTML = resultStr1;
        document.getElementById("result").style.display = "block";
    }

    function autoClickMap(pointid, thiss) {
        mapObj.clearMap();
        lnglatXY = addressArr[pointid];
        selectAddress = selectaddressArr[pointid][0] == "" ? selectaddressArr[pointid][1] : selectaddressArr[pointid][0];
        mapObj.setCenter(lnglatXY);
        _addressName = selectaddressArr[pointid][1];
        geocoder();
    }
    //鼠标滑过查询结果改变背景样式，根据id打开信息窗体
    function openMarkerTipById1(pointid, thiss) {
        thiss.style.background = '#CAE1FF';
        windowsArr[pointid].open(mapObj, searchMarker[pointid]);
    }

    //添加查询结果的marker&infowindow
    function addmarker(i, d) {
        var lngX = d.location.getLng();
        var latY = d.location.getLat();
        var markerOption = {
            map: mapObj,
            icon: "http://webapi.amap.com/images/" + (i + 1) + ".png",
            position: new AMap.LngLat(lngX, latY)
        };
        var mar = new AMap.Marker(markerOption);
        searchMarker.push(new AMap.LngLat(lngX, latY));

        var infoWindow = new AMap.InfoWindow({
            content: "<h3><font color=\"#00a6ac\">  " + (i + 1) + ". " + d.name + "</font></h3>" + TipContents(d.type, d.address, d.tel),
            size: new AMap.Size(300, 0),
            autoMove: true,
            offset: new AMap.Pixel(0, -30)
        });
        windowsArr.push(infoWindow);
        var aa = function (e) { infoWindow.open(mapObj, mar.getPosition()); };
        AMap.event.addListener(mar, "click", aa);
    }

    //infowindow显示内容
    function TipContents(type, address, tel) {  //窗体内容
        if (type == "" || type == "undefined" || type == null || type == " undefined" || typeof type == "undefined") {
            type = "暂无";
        }
        if (address == "" || address == "undefined" || address == null || address == " undefined" || typeof address == "undefined") {
            address = "暂无";
        }
        if (tel == "" || tel == "undefined" || tel == null || tel == " undefined" || typeof address == "tel") {
            tel = "暂无";
        }
        var str = "  地址：" + address + "<br />  电话：" + tel + " <br />  类型：" + type;
        return str;
    }
    function keydown(event) {
        var key = (event || window.event).keyCode;
        var result = document.getElementById("result1")
        var cur = result.curSelect;
        if (key === 40) {//down
            if (cur + 1 < result.childNodes.length) {
                if (result.childNodes[cur]) {
                    result.childNodes[cur].style.background = '';
                }
                result.curSelect = cur + 1;
                result.childNodes[cur + 1].style.background = '#CAE1FF';
                document.getElementById("keyword").value = result.tipArr[cur + 1].name;
            }
        } else if (key === 38) {//up
            if (cur - 1 >= 0) {
                if (result.childNodes[cur]) {
                    result.childNodes[cur].style.background = '';
                }
                result.curSelect = cur - 1;
                result.childNodes[cur - 1].style.background = '#CAE1FF';
                document.getElementById("keyword").value = result.tipArr[cur - 1].name;
            }
        } else if (key === 13) {
            var res = document.getElementById("result1");
            if (res && res['curSelect'] !== -1) {
                selectResult(document.getElementById("result1").curSelect);
            }
        } else {
            autoSearch();
        }
    }
    function walkingComplete(data) {
        if (data.count > 0) {
            alert(data.routes[0].distance);
        }
    }
    function walkingError(data) {
        alert('获取距离信息失败');
    }

    //高德地图(先按照医院主地址,再使用经纬度, 使用步行距离测算)
    function SubmitApplicationCheck() {
        return new Promise(resolve => {
            walking.search([{
                keyword: '西岗区中山路222号', city: '大连'
            }, { keyword: '合益大厦', city: '大连' }], function (status, result) {
                if (status === 'complete') {
                    resolve(true);
                } else {
                    //showTopMsg('获取距离信息失败');
                    resolve(false);
                }
            });
        });
        //check主地址
        //walking.search([{
        //    keyword: '西岗区中山路222号', city: '大连'
        //}, { keyword: '合益大厦', city: '大连' }], function (status, result) {
        //    if (status === 'complete') {
        //        return true;
        //    } else {
        //        showTopMsg('获取距离信息失败');
        //        return false;
        //    }
        //});
    }
    function get(ori, des) {
        var disData;
        $.ajax({
            type: "get",
            url: "https://restapi.amap.com/v3/direction/walking?origin=" + ori + "&destination=" + des + "&key=be67a85eb1ef6e18344653c31760d319",
            cache: false,
            async: false,
            success: function (data) {
                disData = data;
            }
        });
        return disData;
    }

    function SubmitApplication() {
        document.getElementById("btnSubmitApplication").setAttribute("disabled", true);

        if (_actionType == "ADD") {
            if (!isInTimespan(getTimeNow(), timeConfig.AddAddressTimeSpanBegin, timeAdd(timeConfig.AddAddressTimeSpanEnd, timeConfig.cachetime))) {
                document.getElementById("btnSubmitApplication").disabled = false;
                showDlg(MSG_ADDADDRESSWORKINGTIME);
                return;
            }
        }
        if (_actionType == "UPDATE") {
            if (!isInTimespan(getTimeNow(), timeConfig.UpdateAddressTimeSpanBegin, timeAdd(timeConfig.UpdateAddressTimeSpanEnd, timeConfig.cachetime))) {
                document.getElementById("btnSubmitApplication").disabled = false;
                showDlg(MSG_UPDATEADDRESSWORKINGTIME);
                return false;
            }
        }
        if (_actionType == "RESUBMIT") {
            if (!isInTimespan(getTimeNow(), timeConfig.ResubmitAddressTimeSpanBegin, timeAdd(timeConfig.ResubmitAddressTimeSpanEnd, timeConfig.cachetime))) {
                document.getElementById("btnSubmitApplication").disabled = false;
                showDlg(MSG_RESUBMITADDRESSWORKINGTIME);
                return;
            }
        }

        if (resultString == "无效地址") {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg("请正确输入新增地址");

            return;
        }
        var newAddress = $('#keyword').val();

        if (_actionType == "UPDATE" || _actionType == "RESUBMIT") {
            if (newAddress == _addAddressUpdate) {
                document.getElementById("btnSubmitApplication").disabled = false;
                showTopMsg('请修改新增地址');

                return;
            }
        }
        if (newAddress == '' || newAddress == null || newAddress == undefined) {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg('请输入新增地址');

            return;
        }

        //选择的地址
        if (lnglatXY == undefined || lnglatXY.lng == undefined || lnglatXY.lat == undefined) {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg("请在查询结果中选择地址");

            return;
        } else {
            var mSelect = new AMap.Marker({
                map: mapObj,
                draggable: true,
                position: new AMap.LngLat(lnglatXY.lng, lnglatXY.lat)
            });
        }
        if (addProvince == undefined || addCity == undefined || addProvince == 'undefined' || addCity == 'undefined') {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg('请在查询结果中选择地址');

            return;
        }
        if (addProvince != mainProvince) {
            document.getElementById("btnSubmitApplication").disabled = false;
            showDlg('新增外送地址与主地址不在同一省份', '返回', function () { }, 'cancel');

            return;
        }

        if (addCity != "" && addCity != mainCity) {
            document.getElementById("btnSubmitApplication").disabled = false;
            showDlg('新增外送地址与主地址不在同一城市', '返回', function () { }, 'cancel');

            return;
        }

        //起始点和目的地
        var origin = mainLng + "," + mainLat;
        if (mainLat == '0' || mainLng == '0' || mainLat == null || mainLng == null) {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg("获取距离信息失败");

            return;
        }
        var destination = lnglatXY.lng + "," + lnglatXY.lat;
        var re = get(origin, destination);
        var distance;
        if (re.status == 1 && re.count > 0) {
            distance = re.route.paths[0].distance
            if (distance <= 500) {
                document.getElementById("btnSubmitApplication").disabled = false;
                showDlg('新增外送地址距离主地址<=500米', '返回', function () { }, 'cancel');

                return;
            }
        }
        else {
            document.getElementById("btnSubmitApplication").disabled = false;
            showTopMsg("获取距离信息失败");

            return;
        }

        //var p1 = mSelect.getPosition();
        ////主地址
        //var mMain = new AMap.Marker({
        //    map: mapObj,
        //    draggable: true,
        //    position: new AMap.LngLat(mainLng, mainLat)
        //});
        //var p2 = mMain.getPosition();
        ////判断距离
        //var distance = Math.round(p1.distance(p2));
        //if (distance <= 500) {
        //    showDlg('新增外送地址距离主地址<=500米', '返回', function () { }, 'cancel');
        //    return;
        //}

        _market = GetUrlParam('market');
        _ta = GetUrlParam('ta');
        _gskHospitalCode = GetUrlParam('hospitalcode');
        //***************************************************新增地址申请*************************************//
        if (_actionType == "ADD") {
            //其他地址

            post('/P/PreApproval/SearchHospitalByGskHospitalForShow', {
                gskHospital: _gskHospitalCode
            },
                function (d) {
                    hospitalData = d.rows;
                    if (hospitalData.length > 0) {
                        for (var j = 0; j < hospitalData.length; j++) {
                            if (hospitalData[j].MainAddress != "主地址") {
                                var ori = hospitalData[j].Longitude + "," + hospitalData[j].Latitude;
                                var des = lnglatXY.lng + "," + lnglatXY.lat;
                                var reOther = get(ori, des);
                                var distanceOther;
                                if (reOther.status == 1 && reOther.count > 0) {
                                    distanceOther = reOther.route.paths[0].distance
                                    if (distanceOther <= 500) {
                                        document.getElementById("btnSubmitApplication").disabled = false;
                                        showDlg('新增外送地址距离其他地址<=500米', '返回', function () { }, 'cancel');

                                        return;
                                    }
                                }
                                else {
                                    document.getElementById("btnSubmitApplication").disabled = false;
                                    showTopMsg("获取距离信息失败");

                                    return;
                                }

                                //var mOther = new AMap.Marker({
                                //    map: mapObj,
                                //    draggable: true,
                                //    position: new AMap.LngLat(hospitalData[j].Longitude, hospitalData[j].Latitude)
                                //});
                                //var p3 = mOther.getPosition();
                                //var distanceOther = Math.round(p1.distance(p3));
                                //if (distanceOther <= 500) {
                                //    showDlg('新增外送地址距离其他地址<=500米', '返回', function () { }, 'cancel');
                                //    return;
                                //}
                                _otherAddressDistance += hospitalData[j].MainAddress + " " + distanceOther + ";";
                            }
                        }
                    }
                    if (d.rows.length > 0) {
                        for (var k = 0; k < d.rows.length; k++) {
                            for (var i = 0; i < d.rows[k].inProgressList.length; i++) {
                                if (d.rows[k].inProgressList[i].ApprovalStatus == 0 || d.rows[k].inProgressList[i].ApprovalStatus == 9 || d.rows[k].inProgressList[i].ApprovalStatus == 10 ||
                                    d.rows[k].inProgressList[i].ApprovalStatus == 2 || d.rows[k].inProgressList[i].ApprovalStatus == 6 || d.rows[k].inProgressList[i].ApprovalStatus == 8) {
                                    document.getElementById("btnSubmitApplication").disabled = false;
                                    showDlg(d.rows[k].inProgressList[i].ApplierMUDID + '已提交了该医院的新增外送地址申请', '返回', function () { }, 'cancel');

                                    return;
                                }
                            }
                        }
                    }
                    $("#btnSubmitApplication").attr('disabled', true);
                    if (distance >= 3000) {
                        showConfimSub('新增地址距离医院主地址超过3公里，如确定是该医院的其他出入口，请点击继续，否则，请点击取消。', '', function () {
                            post('/P/PreApproval/SaveNewAddress', {
                                Market: _market, TA: _ta, Province: mainProvince, City: mainCity, District: addDistrict, GskHospital: _gskHospitalCode, AddAddress: newAddress,
                                Distance: distance, Latitude: lnglatXY.lat, Longitude: lnglatXY.lng, Count: hospitalData.length, HospitalName: _hospitalName, OtherAddressDistance: _otherAddressDistance,
                                MAddress: mainAddress, AddressNameDisplay: _addressName
                            },
                                function (d) {
                                    if (d.state == 1) {
                                        document.getElementById("btnSubmitApplication").disabled = false;
                                        var _msg = MSG_ADDRESSAPPROVALSUBMITSUCCESS;
                                        showDlg(_msg, undefined, function () {
                                            WeixinJSBridge.call('closeWindow');
                                        }, 'info');
                                    }
                                }, 'json');
                        }, '继续', '取消', function () { document.getElementById("btnSubmitApplication").disabled = false; return; }, 'info');
                    } else {
                        post('/P/PreApproval/SaveNewAddress', {
                            Market: _market, TA: _ta, Province: mainProvince, City: mainCity, District: addDistrict, GskHospital: _gskHospitalCode, AddAddress: newAddress,
                            Distance: distance, Latitude: lnglatXY.lat, Longitude: lnglatXY.lng, Count: hospitalData.length, HospitalName: _hospitalName, OtherAddressDistance: _otherAddressDistance,
                            MAddress: mainAddress, AddressNameDisplay: _addressName
                        },
                            function (d) {
                                if (d.state == 1) {
                                    document.getElementById("btnSubmitApplication").disabled = false;
                                    var _msg = MSG_ADDRESSAPPROVALSUBMITSUCCESS;
                                    showDlg(_msg, undefined, function () {
                                        WeixinJSBridge.call('closeWindow');
                                    }, 'info');
                                }
                            }, 'json');
                    }
                }, 'json');
        }
        //***************************************************修改/重新提交地址申请*************************************//
        else if (_actionType == "UPDATE" || _actionType == "RESUBMIT") {
            _addressApplicationID = GetUrlParam('addressApplicationID');
            //其他地址
            post('/P/PreApproval/SearchHospitalByGskHospitalForShow', {
                gskHospital: _gskHospitalCode
            },
                function (d) {
                    hospitalData = d.rows;
                    if (hospitalData.length > 0) {
                        for (var j = 0; j < hospitalData.length; j++) {
                            if (hospitalData[j].DA_ID != null && hospitalData[j].DA_ID.toString() == _addressApplicationID)
                                continue;
                            if (hospitalData[j].MainAddress != "主地址") {
                                var ori = hospitalData[j].Longitude + "," + hospitalData[j].Latitude;
                                var des = lnglatXY.lng + "," + lnglatXY.lat;
                                var reOther = get(ori, des);
                                var distanceOther;
                                if (reOther.status == 1 && reOther.count > 0) {
                                    distanceOther = reOther.route.paths[0].distance
                                    if (distanceOther <= 500) {
                                        document.getElementById("btnSubmitApplication").disabled = false;
                                        showDlg('新增外送地址距离其他地址<=500米', '返回', function () { }, 'cancel');

                                        return;
                                    }
                                }
                                else {
                                    document.getElementById("btnSubmitApplication").disabled = false;
                                    showTopMsg("获取距离信息失败");

                                    return;
                                }

                                //var mOther = new AMap.Marker({
                                //    map: mapObj,
                                //    draggable: true,
                                //    position: new AMap.LngLat(hospitalData[j].Longitude, hospitalData[j].Latitude)
                                //});
                                //var p3 = mOther.getPosition();
                                //var distanceOther = Math.round(p1.distance(p3));
                                //if (distanceOther <= 500) {
                                //    showDlg('新增外送地址距离其他地址<=500米', '返回', function () { }, 'cancel');
                                //    return;
                                //}
                                _otherAddressDistance += hospitalData[j].MainAddress + " " + distanceOther + ";";
                            }
                            //判断是否有流程中的新增地址
                            for (var k = 0; k < d.rows[j].inProgressList.length; k++) {
                                if (d.rows[j].inProgressList[k].ApprovalStatus == 0 || d.rows[j].inProgressList[k].ApprovalStatus == 9 || d.rows[j].inProgressList[k].ApprovalStatus == 10) {
                                    document.getElementById("btnSubmitApplication").disabled = false;
                                    showDlg(d.rows[j].inProgressList[k].ApplierMUDID + '已提交了该医院的新增外送地址申请', '返回', function () { }, 'cancel');

                                    return;
                                }
                            }
                        }
                        if (distance >= 3000) {
                            showConfimSub('新增地址距离医院主地址超过3公里，如确定是该医院的其他出入口，请点击继续，否则，请点击取消。', '', function () {
                                post('/P/PreApproval/AddressUpdate', {
                                    AddAddress: newAddress, Distance: distance, Latitude: lnglatXY.lat, Longitude: lnglatXY.lng, OtherAddressDistance: _otherAddressDistance,
                                    AddressApprovalID: _addressApplicationID, ActionType: _actionType, Count: hospitalData.length, GskHospital: _gskHospitalCode, MAddress: mainAddress, AddressNameDisplay: _addressName
                                },
                                    function (d) {
                                        if (d.state == 1) {
                                            document.getElementById("btnSubmitApplication").disabled = false;
                                            var _msg;
                                            if (_actionType == "UPDATE")
                                                _msg = MSG_ADDRESSAPPROVALUPDATESUCCESS;
                                            else if (_actionType == "RESUBMIT")
                                                _msg = MSG_ADDRESSAPPROVALRESUBMITSUCCESS;
                                            showDlg(_msg, undefined, function () {
                                                WeixinJSBridge.call('closeWindow');
                                            }, 'info');
                                        }
                                    }, 'json');
                            }, '继续', '取消', function () { document.getElementById("btnSubmitApplication").disabled = false; return; }, 'info');
                        } else {
                            post('/P/PreApproval/AddressUpdate', {
                                AddAddress: newAddress, Distance: distance, Latitude: lnglatXY.lat, Longitude: lnglatXY.lng, OtherAddressDistance: _otherAddressDistance,
                                AddressApprovalID: _addressApplicationID, ActionType: _actionType, Count: hospitalData.length, GskHospital: _gskHospitalCode, MAddress: mainAddress, AddressNameDisplay: _addressName
                            },
                                function (d) {
                                    if (d.state == 1) {
                                        document.getElementById("btnSubmitApplication").disabled = false;
                                        var _msg;
                                        if (_actionType == "UPDATE")
                                            _msg = MSG_ADDRESSAPPROVALUPDATESUCCESS;
                                        else if (_actionType == "RESUBMIT")
                                            _msg = MSG_ADDRESSAPPROVALRESUBMITSUCCESS;
                                        showDlg(_msg, undefined, function () {
                                            WeixinJSBridge.call('closeWindow');
                                        }, 'info');
                                    }
                                }, 'json');
                        }
                    }
                }, 'json');
        }

        //var geocoder = new AMap.Geocoder({
        //    city: ""//城市，默认：“全国”
        //});
        //var lnglatXYZ = [120.6315218, 29.89422627];//地图上所标点的坐标
        //geocoder.getAddress(lnglatXYZ, function (status, result) {
        //    if (status === 'complete' && result.info === 'OK') {
        //        //获得了有效的地址信息:
        //        //即，result.regeocode.formattedAddress
        //        //console.log(result);
        //        var city = result.regeocode.addressComponent.city;
        //    } else {
        //        var city = '获取失败';
        //        //获取地址失败
        //    }
        //    document.getElementById("city").value = city;
        //    console.log(city);
        //});


        ////var textPos = p1.divideBy(2).add(p2.divideBy(2));

        ////alert("距离:" + distance + "米");
        //var _msg = MSG_PREAPPROVALSUBMITSUCCESS;
        //showDlg(_msg, undefined, function () {
        //    WeixinJSBridge.call('closeWindow');
        //}, 'info');
    }

</script>
}
<link rel="stylesheet" href="~/Content/css/map.css?v=javaScriptVersion" />
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
    var jsapiurl = '@MealH5.Handler.WebConfigHandler.ShortUrlService/JsApi/QyConfigJs?debug=false&url=' + UrlEncode(window.location.href);
    document.write('<script type="text/javascript" src="' + jsapiurl + '"><\/script>');
</script>

<div class="page-main">
    <div style="position: absolute;top: 0px;left: 0px;right: 0px;bottom: 0px;height:80px;z-index:10000; background: #FFF;">
        <div style="margin-left:5px;margin-top:5px;">
            <label id="province" class="l_text"></label>
            <label id="city" class="l_text"></label>
        </div>
        <div style="margin-left:5px;margin-top:5px;">
            <label id="address" class="l_text"></label>
        </div>
        <div style="margin-left:5px;margin-top:5px;">
            <label class="l_text">新增地址：</label>
            <input id="keyword" onkeyup="keydown();" class="inputTextStyle" type="text" />
            <div id="result1" name="result1" style="overflow: auto; width: 95%;z-index:10000; border: 1px solid gray;display: none;background-color:white;"></div>
        </div>
    </div>
    <div class="page-body">
        <div id="mapBg" style="position: relative;display: none;padding-top:70px;">
            <div id="iCenter"></div>
            <div class="demo_box">

                <div id="r_title"><b>查询结果:</b></div>
                <div id="result"></div>
            </div>
        </div>
    </div>
    <div class="page-foot">
        <div class="page__bd page__bd_spacing">
            <div class="weui-flex">
                <div class="weui-flex__item">
                    <div class="placeholder">
                        <form id="form1" action="~/P/Food/MMCoE" method="get"></form>
                        <button onclick="SubmitApplication();" id="btnSubmitApplication" class="weui-btn weui-btn_orange">提交申请</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
